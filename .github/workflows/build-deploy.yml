name: Build and Deploy Services

on:
  push:
    branches:
      - main

jobs:
  auth_service:
    uses: ./.github/workflows/service-pipeline.yml
    with:
      service_name: auth_service
      context: ./auth_service
      dockerfile: ./auth_service/Dockerfile
      image: registry.heroku.com/tank-auth-service/web
      test_command: "pytest auth_service/tests -q"
      workdir: /app
      push: true
      release_app: tank-auth-service
    secrets: inherit

  backend:
    uses: ./.github/workflows/service-pipeline.yml
    with:
      service_name: backend
      context: ./backend
      dockerfile: ./backend/Dockerfile
      image: registry.heroku.com/tank-backend-service/web
      test_command: "pytest tests -q"
      workdir: /app/backend
      push: true
      release_app: tank-backend-service
    secrets: inherit

  prod-tests:
    needs:
      - auth_service
      - backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: python -m pip install -r production_tests/requirements.txt

      - name: Run production smoke tests
        env:
          AUTH_BASE_URL: https://auth.kanade.02labs.me
          BACKEND_BASE_URL: https://control.kanade.02labs.me
          PROD_LOGIN_USER: ${{ secrets.PROD_LOGIN_USER }}
          PROD_LOGIN_PASSWORD: ${{ secrets.PROD_LOGIN_PASSWORD }}
          PROD_TEST_USER: ${{ secrets.PROD_TEST_USER }}
          PROD_TEST_PASSWORD: ${{ secrets.PROD_TEST_PASSWORD }}
          PROD_MONGODB_URI: ${{ secrets.PROD_MONGODB_URI }}
        run: python -m pytest production_tests -q
